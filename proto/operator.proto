syntax = "proto3";
package cnpgi.adapter.v1;
option go_package = "github.com/cloudnative-pg/cnpg-i/pkg/operator";

service Operator {
  // GetCapabilities gets the capabilities of the WAL service
  rpc GetCapabilities(OperatorCapabilitiesRequest) returns (OperatorCapabilitiesResult) {}

  // ValidateCreate improves the behaviour of the validating webhook that
  // is called on creation of the Cluster resources
  rpc ValidateClusterCreate(OperatorValidateClusterCreateRequest) returns (OperatorValidateClusterCreateResult) {}

  // ValidateClusterChange improves the behavior of the validating webhook of
  // is called on updates of the Cluster resources
  rpc ValidateClusterChange(OperatorValidateClusterChangeRequest) returns (OperatorValidateClusterChangeResult) {}

  // MutateCluster fills in the defaults inside a Cluster resource
  rpc MutateCluster(OperatorMutateClusterRequest) returns (OperatorMutateClusterResult) {}

  // MutatePod reconciles a Pod definition before it
  // is applied in the Kubernetes cluster
  rpc MutatePod(OperatorMutatePodRequest) returns (OperatorMutatePodResult) {}

  // PreReconcile is executed after the operator gets the resources and update
  // the status.
  rpc PreReconcile(OperatorPreReconcileRequest) returns (OperatorPreReconcileResult) {}

  // PostReconcile is executed at the end of the reconciliation loop
  rpc PostReconcile(OperatorPostReconcileRequest) returns (OperatorPostReconcileResult) {}
}

message OperatorMutatePodRequest {
  // This field is REQUIRED. Value of this field is the JSON
  // serialization of the Cluster corresponding to the Pod being applied
  bytes cluster_definition = 1;

  // This field is REQUIRED. Value of this field is the JSON
  // serialization of the Pod that is being applied
  bytes pod_definition = 2;
}

message OperatorMutatePodResult {
  // This field is OPTIONAL. Value of this field is a JSONPatch
  // to be applied on the passed Pod definition
  bytes json_patch = 1;
}

message OperatorCapabilitiesRequest {
  // Intentionally empty.
}

message OperatorCapabilitiesResult {
  // All the capabilities that the controller service supports. This
  // field is OPTIONAL.
  repeated OperatorCapability capabilities = 1;
}

message OperatorValidateClusterCreateRequest {
  // This field is REQUIRED. Value of this field is the JSON
  // serialization of the Cluster that is being created
  bytes definition = 1;
}

message OperatorValidateClusterCreateResult {
  // This field is OPTIONAL. Value of this field is a set
  // of validation errors
  repeated ValidationError validation_errors = 1;
}

message OperatorValidateClusterChangeRequest {
  // This field is REQUIRED. Value of this field is the JSON
  // serialization of the current Cluster definition
  bytes old_cluster = 1;

  // This field is REQUIRED. Value of this field is the JSON
  // serialization of the updated Cluster definition
  bytes new_cluster = 2;
}

message OperatorValidateClusterChangeResult {
  // This field is OPTIONAL. Value of this field is a set
  // of validation errors
  repeated ValidationError validation_errors = 1;
}

message OperatorMutateClusterRequest {
  // This field is REQUIRED. Value of this field is the JSON
  // serialization of the Cluster that should receive the
  // default values
  bytes definition = 1;
}

message OperatorMutateClusterResult {
  // This field is OPTIONAL. Value of this field is a JSONPatch
  // to be applied on the passed Cluster definition
  bytes json_patch = 1;
}

message ValidationError {
  // This field is REQUIRED. Value of this field is 
  repeated string path_components = 1;

  // This field is REQUIRED. Value of this field is 
  // the value that caused a validation error
  string value = 2;

  // This field is REQUIRED. Value of this field is a
  // description of the validation error
  string message = 3;
}

message OperatorCapability {
  message RPC {
    enum Type {
      TYPE_UNSPECIFIED = 0;

      // TYPE_VALIDATE_CLUSTER_CREATE indicates that the Plugin is able to
      // reply to the ValidateClusterCreate RPC request
      TYPE_VALIDATE_CLUSTER_CREATE = 1;

      // TYPE_VALIDATE_CLUSTER_CHANGE indicates that the Plugin is able to
      // reply to the ValidateClusterChange RPC request
      TYPE_VALIDATE_CLUSTER_CHANGE = 2;

      // TYPE_MUTATE_CLUSTER indicates that the Plugin is able to
      // reply to the MutateCluster RPC request
      TYPE_MUTATE_CLUSTER = 3;

      // TYPE_MUTATE_POD indicates that the Plugin is able to
      // reply to the MutatePod RPC request
      TYPE_MUTATE_POD = 4;

      // TYPE_PRE_RECONCILE indicates that the Plugin is able to
      // reply to the PreReconcile RPC request
      TYPE_PRE_RECONCILE = 5;

      // TYPE_POST_RECONCILE indicates that the Plugin is able to
      // reply to the PostReconcile RPC request
      TYPE_POST_RECONCILE = 6;
    }

    Type type = 1;
  }

  oneof type {
    RPC rpc = 1;
  }
}

message OperatorPreReconcileRequest {
  // This field is REQUIRED. Value of this field is the JSON
  // serialization of the Cluster corresponding to the Pod being applied
  bytes cluster_definition = 1;
}

message OperatorPreReconcileResult {
  // This field is REQUIRED. If true, the current reconciliation loop
  // will be stopped and a new one will be requested.
  bool requeue = 1;

  // This field is OPTIONAL. If true, the current reconciliation loop
  // will be stopped and the operator will ensure that another one will
  // be run in the requested number of seconds. IMPORTANT: the new
  // reconciliation loop may start even before the number of specified
  // seconds.
  int64 requeue_after = 2;
}

message OperatorPostReconcileRequest {
  // This field is REQUIRED. Value of this field is the JSON
  // serialization of the Cluster corresponding to the Pod being applied
  bytes cluster_definition = 1;
}

message OperatorPostReconcileResult {
  // This field is REQUIRED. If true, the current reconciliation loop
  // will be stopped and a new one will be requested.
  bool requeue = 1;

  // This field is OPTIONAL. If true, the current reconciliation loop
  // will be stopped and the operator will ensure that another one will
  // be run in the requested number of seconds. IMPORTANT: the new
  // reconciliation loop may start even before the number of specified
  // seconds.
  int64 requeue_after = 2;
}