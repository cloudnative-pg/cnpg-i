syntax = "proto3";
package cnpgi.operator_lifecycle.v1;
option go_package = "github.com/cloudnative-pg/cnpg-i/pkg/lifecycle";

service OperatorLifecycle {
  // GetCapabilities gets the capabilities of the Lifecycle service
  rpc GetCapabilities(OperatorLifecycleCapabilitiesRequest) returns (OperatorLifecycleCapabilitiesResponse) {}

  // LifecycleHook allows the plugin to manipulate the Kubernetes resources
  // before the CNPG operator applies them to the Kubernetes cluster.
  rpc LifecycleHook(OperatorLifecycleRequest) returns (OperatorLifecycleResponse) {}
}

message OperatorLifecycleCapabilitiesRequest {
  // This message is intentionally empty
}

message OperatorLifecycleCapabilitiesResponse {
  // This message is OPTIONAL, containing the list of resources
  // for which the lifecycle hook is called
  repeated OperatorLifecycleCapabilities lifecycle_capabilities = 1;
}

message OperatorLifecycleCapabilities {
  // The Kubernetes resource group (such as "apps" or empty for core resources)
  string group = 1;

  // The Kubernetes Kind name (such as "Cluster" or "Pod")
  string kind = 2;

  // The operation type
  repeated OperatorOperationType operation_types = 3;
}

message OperatorOperationType {
  enum Type {
    TYPE_UNSPECIFIED = 0;
    // This is invoked when the operator executes a Patch request on the resource
    TYPE_PATCH = 1;
    // This is invoked when the operator executes an Update request on the resource
    TYPE_UPDATE = 2;
    // This is invoked when the operator executes a Create request on the resource
    TYPE_CREATE = 3;
    // This is invoked when the operator executes a Delete request on the resource
    TYPE_DELETE = 4;
    // Reserved for future use.
    TYPE_DEREGISTER = 5;
    // The operator calls this to perform a dry-run evaluation to determine if the plugin
    // would make changes to the resource without actually applying them. This allows for
    // validation and impact assessment before performing actual operations.
    // A positive evaluation (changes that can potentially be applied) triggers calls to the Update, Patch,
    // or Delete verbs.
    // Currently only selected resources have support for this operation type (e.g., pod instances).
    TYPE_EVALUATE = 6;
  }

  Type type = 1;
}

message OperatorLifecycleRequest {
  // This field is REQUIRED.
  OperatorOperationType operation_type = 1;
  // This field is REQUIRED
  bytes cluster_definition = 2;
  // This field is REQUIRED.
  bytes object_definition = 3;
}

message OperatorLifecycleResponse {
  // This field is OPTIONAL.
  bytes json_patch = 1;
}
